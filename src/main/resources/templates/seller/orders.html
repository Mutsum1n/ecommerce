<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>订单管理 - 卖家</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/seller">卖家中心</a>
        <div class="navbar-nav">
            <a class="nav-link" href="/seller/products">商品管理</a>
            <a class="nav-link active" href="/seller/orders">订单管理</a>
            <a class="nav-link" href="/seller/reports">销售报表</a>
            <a class="nav-link" href="/seller/customers">客户管理</a>
            <a class="nav-link text-light" href="/products">返回商品页</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2><i class="bi bi-receipt"></i> 订单管理</h2>

    <!-- 成功消息 -->
    <div th:if="${param.success != null}" class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle"></i> 操作成功！
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.error != null}" class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle"></i> 操作失败！
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${orders != null and !orders.isEmpty()}">
        <div class="table-responsive mt-3">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>订单号</th>
                    <th>客户</th>
                    <th>下单时间</th>
                    <th>商品数量</th>
                    <th>订单金额</th>
                    <th>订单状态</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="order : ${orders}">
                    <td><strong th:text="${order.id}"></strong></td>
                    <td>
                        <div>
                            <strong th:text="${order.user != null ? order.user.fullName : '未知用户'}"></strong>
                            <small class="text-muted d-block"
                                   th:text="${order.user != null ? order.user.username : 'N/A'}">
                            </small>
                        </div>
                    </td>
                    <td th:text="${#temporals.format(order.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                    <td>
                        <span th:if="${order.orderItems != null}"
                              th:text="${order.orderItems.size()} + '件'">
                        </span>
                        <span th:unless="${order.orderItems != null}">0件</span>
                    </td>
                    <td>
                        <strong class="text-danger">
                            <span th:if="${order.totalAmount != null}"
                                  th:text="'¥' + ${#numbers.formatDecimal(order.totalAmount, 1, 2)}">
                            </span>
                            <span th:unless="${order.totalAmount != null}">¥0.00</span>
                        </strong>
                    </td>
                    <td>
                        <span th:if="${order.status != null}">
                            <span th:if="${order.status.name() == 'PENDING'}" class="badge bg-warning text-dark">待处理</span>
                            <span th:if="${order.status.name() == 'PAID'}" class="badge bg-info">已付款</span>
                            <span th:if="${order.status.name() == 'SHIPPED'}" class="badge bg-primary">已发货</span>
                            <span th:if="${order.status.name() == 'DELIVERED'}" class="badge bg-success">已送达</span>
                            <span th:if="${order.status.name() == 'CANCELLED'}" class="badge bg-danger">已取消</span>
                            <span th:if="${order.status.name() == 'REFUNDED'}" class="badge bg-warning">已退款</span>
                            <span th:if="${order.status.name() == 'COMPLETED'}" class="badge bg-success">已完成</span>
                            <span th:if="${order.status.name() == null or order.status.name() == ''}"
                                  class="badge bg-secondary">未知</span>
                        </span>
                        <span th:unless="${order.status != null}" class="badge bg-secondary">无状态</span>
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown"
                                        th:disabled="${order.status == null}">
                                    更新状态
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <form th:action="@{/seller/orders/{id}/status(id=${order.id})}"
                                              method="post" class="status-action-form">
                                            <input type="hidden" name="status" value="PAID">
                                            <button type="submit" class="dropdown-item">
                                                <span class="badge bg-info me-1">●</span> 已付款
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form th:action="@{/seller/orders/{id}/status(id=${order.id})}"
                                              method="post" class="status-action-form">
                                            <input type="hidden" name="status" value="SHIPPED">
                                            <button type="submit" class="dropdown-item">
                                                <span class="badge bg-primary me-1">●</span> 已发货
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form th:action="@{/seller/orders/{id}/status(id=${order.id})}"
                                              method="post" class="status-action-form">
                                            <input type="hidden" name="status" value="DELIVERED">
                                            <button type="submit" class="dropdown-item">
                                                <span class="badge bg-success me-1">●</span> 已送达
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form th:action="@{/seller/orders/{id}/status(id=${order.id})}"
                                              method="post" class="status-action-form">
                                            <input type="hidden" name="status" value="CANCELLED">
                                            <button type="submit" class="dropdown-item">
                                                <span class="badge bg-danger me-1">●</span> 已取消
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form th:action="@{/seller/orders/{id}/status(id=${order.id})}"
                                              method="post" class="status-action-form">
                                            <input type="hidden" name="status" value="REFUNDED">
                                            <button type="submit" class="dropdown-item">
                                                <span class="badge bg-warning me-1">●</span> 已退款
                                            </button>
                                        </form>
                                    </li>
                                    <li>
                                        <form th:action="@{/seller/orders/{id}/status(id=${order.id})}"
                                              method="post" class="status-action-form">
                                            <input type="hidden" name="status" value="COMPLETED">
                                            <button type="submit" class="dropdown-item">
                                                <span class="badge bg-success me-1">●</span> 已完成
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div th:if="${orders == null or orders.isEmpty()}" class="text-center mt-5">
        <i class="bi bi-cart-x display-1 text-muted"></i>
        <h4 class="mt-3">暂无订单</h4>
        <p class="text-muted">目前还没有任何订单记录</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 自动关闭警告消息
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });

        // 防止表单重复提交
        const forms = document.querySelectorAll('.status-action-form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitButton = this.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton. Disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
                }
            });
        });
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>客户详情 - 卖家中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/seller">卖家中心</a>
        <div class="navbar-nav">
            <a class="nav-link" href="/seller/products">商品管理</a>
            <a class="nav-link" href="/seller/orders">订单管理</a>
            <a class="nav-link" href="/seller/reports">销售报表</a>
            <a class="nav-link active" href="/seller/customers">客户管理</a>
            <a class="nav-link text-light" href="/products">返回商品页</a>
        </div>
    </div>
</nav>

<div id="alertContainer"></div>

<div class="container mt-4">
    <div th:if="${success != null}" class="alert alert-success alert-dismissible fade show mb-3">
        <i class="bi bi-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error != null}" class="alert alert-danger alert-dismissible fade show mb-3">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <span th:utext="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/seller/customers" class="back-link text-primary">
            <i class="bi bi-arrow-left"></i> 返回客户列表
        </a>
        <h2 class="mb-0"><i class="bi bi-person-circle"></i> 客户详情</h2>
        <div></div>
    </div>

    <!-- 客户基本信息卡片 -->
    <div class="card customer-info-card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">客户基本信息</h5>
            <span class="badge bg-primary">客户ID: <span th:text="${customer.id}">1</span></span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-person fs-4 me-3 text-primary"></i>
                        <div>
                            <h6 class="mb-0">用户名</h6>
                            <p class="mb-0 fs-5" th:text="${customer.username}">customer123</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-card-text fs-4 me-3 text-primary"></i>
                        <div>
                            <h6 class="mb-0">姓名</h6>
                            <p class="mb-0 fs-5" th:text="${customer.fullName != null ? customer.fullName : '未填写'}">张三</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-envelope fs-4 me-3 text-primary"></i>
                        <div>
                            <h6 class="mb-0">邮箱</h6>
                            <p class="mb-0 fs-5" th:text="${customer.email != null ? customer.email : '未填写'}">customer@example.com</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-phone fs-4 me-3 text-primary"></i>
                        <div>
                            <h6 class="mb-0">手机号</h6>
                            <p class="mb-0 fs-5" th:text="${customer.phone != null ? customer.phone : '未填写'}">13800138000</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-calendar-check fs-4 me-3 text-primary"></i>
                        <div>
                            <h6 class="mb-0">注册时间</h6>
                            <p class="mb-0 fs-5" th:text="${#temporals.format(customer.createdAt, 'yyyy-MM-dd HH:mm:ss')}">2023-01-15 10:30:00</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-clock-history fs-4 me-3 text-primary"></i>
                        <div>
                            <h6 class="mb-0">最后更新</h6>
                            <p class="mb-0 fs-5" th:text="${#temporals.format(customer.updatedAt, 'yyyy-MM-dd HH:mm:ss')}">2023-03-20 14:45:00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-cart-check"></i> 订单记录</h5>
                    <span class="badge bg-primary rounded-pill" th:text="${orders != null ? orders.size() : 0}">3</span>
                </div>
                <div class="card-body p-0">
                    <div th:if="${orders == null or orders.isEmpty()}" class="empty-state">
                        <i class="bi bi-cart-x"></i>
                        <h5>暂无订单记录</h5>
                        <p class="text-muted">该客户尚未在本店购买商品</p>
                    </div>

                    <div th:unless="${orders == null or orders.isEmpty()}" class="table-responsive">
                        <table class="table table-hover order-table mb-0">
                            <thead>
                            <tr>
                                <th>订单号</th>
                                <th>下单时间</th>
                                <th>订单状态</th>
                                <th>订单金额</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="order : ${orders}">
                                <td th:text="${order.id}">1001</td>
                                <td th:text="${#temporals.format(order.createdAt, 'yyyy-MM-dd HH:mm')}">2023-03-15 14:30</td>
                                <td>
                                    <!-- 使用Thymeleaf的字符串方法转换大小写 -->
                                    <span th:with="status=${#strings.toUpperCase(order.status)}"
                                          th:switch="${status}"
                                          class="badge badge-status">
                                        <span th:case="'PENDING'" class="badge bg-warning text-dark">待处理</span>
                                        <span th:case="'PAID'" class="badge bg-info">已付款</span>
                                        <span th:case="'SHIPPED'" class="badge bg-primary">已发货</span>
                                        <span th:case="'DELIVERED'" class="badge bg-success">已送达</span>
                                        <span th:case="'CANCELLED'" class="badge bg-danger">已取消</span>
                                        <span th:case="'COMPLETED'" class="badge bg-success">已完成</span>
                                        <span th:case="'REFUNDED'" class="badge bg-dark">已退款</span>
                                        <span th:case="*" class="badge bg-secondary" th:text="${order.status}"></span>
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${order.totalAmount != null}" th:text="${#numbers.formatDecimal(order.totalAmount, 1, 2)}">99.99</span>
                                    <span th:unless="${order.totalAmount != null}">0.00</span>元
                                </td>
                                <td>
                                    <a th:href="@{/seller/orders}" class="btn btn-sm btn-outline-primary">查看详情</a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 客户统计</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>订单总数</span>
                        <span class="fw-bold fs-5" th:text="${orders != null ? orders.size() : 0}">3</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>总消费金额</span>
                        <span class="fw-bold fs-5 text-success">
                            <span th:if="${orders == null or orders.isEmpty()}">0.00</span>
                            <span th:unless="${orders == null or orders.isEmpty()}">
                                <span th:text="${#numbers.formatDecimal(#aggregates.sum(orders.?[status != 'CANCELLED'].![totalAmount]), 1, 2)}">299.97</span>
                            </span>元
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>活动记录数</span>
                        <span class="fw-bold fs-5" th:text="${activities != null ? activities.size() : 0}">12</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>最近活跃</span>
                        <span class="fw-bold fs-6" th:if="${activities != null and not activities.isEmpty()}" th:text="${#temporals.format(activities[0].createdAt, 'yyyy-MM-dd HH:mm')}">2023-03-25 16:20</span>
                        <span class="fw-bold fs-6" th:if="${activities == null or activities.isEmpty()}">无记录</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> 客户活动日志</h5>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary active" id="showAllLogs">全部</button>
                <button type="button" class="btn btn-outline-success" id="showViewLogs">浏览记录</button>
                <button type="button" class="btn btn-outline-danger" id="showPurchaseLogs">购买记录</button>
            </div>
        </div>
        <div class="card-body">
            <div th:if="${activities == null or activities.isEmpty()}" class="empty-state">
                <i class="bi bi-journal-x"></i>
                <h5>暂无活动记录</h5>
                <p class="text-muted">该客户尚未有浏览或购买活动</p>
            </div>

            <div th:unless="${activities == null or activities.isEmpty()}" class="activity-log" id="activityLogContainer">
                <div th:each="activity : ${activities}"
                     th:data-activity-type="${activity.activityType != null ? activity.activityType : ''}"
                     th:classappend="${activity.activityType != null and (activity.activityType.contains('VIEW') or activity.activityType.contains('VIEW_PRODUCT')) ? 'view' :
                                      activity.activityType != null and activity.activityType.contains('PURCHASE') ? 'purchase' : 'other'}"
                     class="log-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <span th:if="${activity.activityType == 'VIEW_PRODUCT'}">
                                    <i class="bi bi-eye text-success"></i> 浏览商品
                                </span>
                                <span th:if="${activity.activityType == 'ADD_TO_CART'}">
                                    <i class="bi bi-cart-plus text-primary"></i> 加入购物车
                                </span>
                                <span th:if="${activity.activityType == 'PURCHASE'}">
                                    <i class="bi bi-bag-check text-danger"></i> 购买商品
                                </span>
                                <span th:if="${activity.activityType == 'LOGIN'}">
                                    <i class="bi bi-box-arrow-in-right text-info"></i> 登录系统
                                </span>
                                <span th:if="${activity.activityType == 'LOGOUT'}">
                                    <i class="bi bi-box-arrow-right text-info"></i> 退出系统
                                </span>
                                <span th:if="${activity.activityType == 'SEARCH'}">
                                    <i class="bi bi-search text-warning"></i> 搜索商品
                                </span>
                                <span th:if="${activity.activityType != null and
                                              activity.activityType != 'VIEW_PRODUCT' and
                                              activity.activityType != 'ADD_TO_CART' and
                                              activity.activityType != 'PURCHASE' and
                                              activity.activityType != 'LOGIN' and
                                              activity.activityType != 'LOGOUT' and
                                              activity.activityType != 'SEARCH'}">
                                    <i class="bi bi-activity text-secondary"></i>
                                    <span th:text="${activity.activityType}">其他活动</span>
                                </span>
                                <span th:if="${activity.activityType == null}">
                                    <i class="bi bi-activity text-secondary"></i> 未知活动
                                </span>
                            </h6>
                            <p class="mb-1" th:text="${activity.details}">浏览了商品：iPhone 14 Pro Max</p>
                            <small class="text-muted">
                                <i class="bi bi-clock"></i>
                                <span th:text="${#temporals.format(activity.createdAt, 'yyyy-MM-dd HH:mm:ss')}">2023-03-25 16:20:30</span>
                                <span th:if="${activity.productId != null}"> |
                                    商品ID:
                                    <a th:href="@{/products/{id}(id=${activity.productId})}"
                                       class="product-link"
                                       th:text="${activity.productId}">123</a>
                                </span>
                            </small>
                        </div>
                        <div class="text-end">
                            <span th:if="${activity.activityType == 'VIEW_PRODUCT'}" class="badge bg-success">浏览</span>
                            <span th:if="${activity.activityType == 'PURCHASE'}" class="badge bg-danger">购买</span>
                            <span th:if="${activity.activityType == 'ADD_TO_CART'}" class="badge bg-primary">加购</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 活动日志筛选功能
        const showAllLogsBtn = document.getElementById('showAllLogs');
        const showViewLogsBtn = document.getElementById('showViewLogs');
        const showPurchaseLogsBtn = document.getElementById('showPurchaseLogs');
        const activityLogContainer = document.getElementById('activityLogContainer');

        if (activityLogContainer && showAllLogsBtn && showViewLogsBtn && showPurchaseLogsBtn) {
            const logItems = activityLogContainer.querySelectorAll('.log-item');

            function filterLogs(type) {
                logItems.forEach(item => {
                    if (type === 'all') {
                        item.style.display = 'block';
                    } else if (type === 'view') {
                        const activityType = item.getAttribute('data-activity-type');
                        if (activityType && (activityType.includes('VIEW') || activityType.includes('VIEW_PRODUCT'))) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    } else if (type === 'purchase') {
                        const activityType = item.getAttribute('data-activity-type');
                        if (activityType && activityType.includes('PURCHASE')) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                });

                // 更新按钮状态
                [showAllLogsBtn, showViewLogsBtn, showPurchaseLogsBtn].forEach(btn => {
                    btn.classList.remove('active');
                });

                if (type === 'all') showAllLogsBtn.classList.add('active');
                if (type === 'view') showViewLogsBtn.classList.add('active');
                if (type === 'purchase') showPurchaseLogsBtn.classList.add('active');
            }

            showAllLogsBtn.addEventListener('click', () => filterLogs('all'));
            showViewLogsBtn.addEventListener('click', () => filterLogs('view'));
            showPurchaseLogsBtn.addEventListener('click', () => filterLogs('purchase'));
        }

        // 显示来自控制器Flash属性的消息
        const successMessage = document.querySelector('.alert-success');
        const errorMessage = document.querySelector('.alert-danger');

        if (successMessage) {
            showFixedAlert('success', successMessage.querySelector('span').textContent);
        }
        if (errorMessage) {
            showFixedAlert('danger', errorMessage.querySelector('span').innerHTML);
        }

        // 显示来自URL参数的消息
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('success')) {
            const successMsg = decodeURIComponent(urlParams.get('success'));
            showFixedAlert('success', successMsg);
        }
        if (urlParams.has('error')) {
            const errorMsg = decodeURIComponent(urlParams.get('error'));
            showFixedAlert('danger', errorMsg);
        }

        // 自动关闭页面内的警告消息
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                if (alert.parentNode) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        });

        function showFixedAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-fixed`;
            alertDiv.innerHTML = `
                <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            alertContainer.appendChild(alertDiv);

            // 5秒后自动关闭
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    const bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }
            }, 5000);

            // 点击关闭按钮时移除
            alertDiv.querySelector('.btn-close').addEventListener('click', function() {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 150);
            });
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>商品详情 - 黄瓜网</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link href="/css/style.css" rel="stylesheet">

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/products"><i class="bi bi-shop"></i> 黄瓜网</a>
        <div class="navbar-nav">
            <a class="nav-link active" href="/products">商品列表</a>
            <a class="nav-link" href="/cart">我的购物车</a>
            <a class="nav-link" href="/buyer">我的订单</a>
            <a class="nav-link" href="/seller" sec:authorize="hasRole('SELLER')">卖家中心</a>
            <a class="nav-link text-light" href="/login" sec:authorize="!isAuthenticated()">登录</a>
            <span class="nav-link text-light" sec:authorize="isAuthenticated()">欢迎，[[${username}]]</span>
            <a class="nav-link text-light" href="/logout" sec:authorize="isAuthenticated()">退出登录</a>
        </div>
    </div>
</nav>

<div class="toast-container toast-custom">
    <div id="success-toast" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">成功</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            <i class="bi bi-cart-check me-2"></i> 商品已成功加入购物车！
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="mb-3">
        <a href="/products" class="back-link text-primary">
            <i class="bi bi-arrow-left"></i> 返回商品列表
        </a>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card product-info-card mb-4">
                <div class="card-body text-center">
                    <img th:src="${product.imageUrl ?: '/images/default-product.jpg'}"
                         class="product-detail-img"
                         alt="[[${product.name}]]">
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card product-info-card mb-4">
                <div class="card-body">
                    <div class="mb-3">
                        <span th:if="${product.stock <= 0}" class="badge bg-danger stock-badge">
                            <i class="bi bi-x-circle"></i> 缺货
                        </span>
                        <span th:if="${product.stock > 0 && product.stock <= 10}" class="badge bg-warning stock-badge">
                            <i class="bi bi-exclamation-triangle"></i> 仅剩 [[${product.stock}]] 件
                        </span>
                        <span th:if="${product.stock > 10}" class="badge bg-success stock-badge">
                            <i class="bi bi-check-circle"></i> 有货
                        </span>
                        <span th:if="${!product.available}" class="badge bg-secondary stock-badge">
                            <i class="bi bi-pause-circle"></i> 已下架
                        </span>
                    </div>

                    <h1 class="h3 mb-3" th:text="${product.name}">商品名称</h1>
                    <div class="d-flex align-items-center mb-4">
                        <h2 class="text-danger mb-0" th:text="'¥' + ${#numbers.formatDecimal(product.price, 1, 2)}">¥0.00</h2>
                        <span class="ms-3 text-muted">
                            <i class="bi bi-box"></i> 库存: [[${product.stock}]] 件
                        </span>
                    </div>

                    <div class="mb-4">
                        <h4 class="h6 text-muted mb-2">商品描述</h4>
                        <p th:text="${product.description != null ? product.description : '暂无描述'}"
                           class="text-muted">
                            商品描述内容...
                        </p>
                    </div>

                    <div class="seller-info mb-4">
                        <h4 class="h6 text-muted mb-2">卖家信息</h4>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person-circle fs-4 me-2 text-primary"></i>
                            <div>
                                <h5 class="mb-1" th:text="${product.seller.fullName != null ? product.seller.fullName : product.seller.username}">卖家名称</h5>
                                <small class="text-muted" th:text="'用户名: ' + ${product.seller.username}">用户名</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <form th:action="@{/cart/add}" method="post" id="addToCartForm">
                            <input type="hidden" name="productId" th:value="${product.id}">

                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <label class="form-label" for="quantity">数量:</label>
                                </div>
                                <div class="col-auto">
                                    <input type="number" name="quantity" id="quantity"
                                           class="form-control quantity-input"
                                           value="1" min="1"
                                           th:max="${product.stock}"
                                           th:disabled="${product.stock <= 0 or not product.available}">
                                </div>
                                <div class="col">
                                    <button type="submit"
                                            class="btn btn-primary w-100"
                                            th:disabled="${product.stock <= 0 or not product.available}">
                                        <i class="bi bi-cart-plus"></i> 加入购物车
                                    </button>
                                </div>
                            </div>

                            <div th:if="${product.stock <= 0}" class="alert alert-warning mt-3 mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i> 该商品暂时缺货，无法购买
                            </div>
                            <div th:if="${!product.available}" class="alert alert-secondary mt-3 mb-0">
                                <i class="bi bi-pause-circle me-2"></i> 该商品已下架，无法购买
                            </div>
                        </form>
                    </div>

                    <div class="border-top pt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="bi bi-calendar-plus"></i> 上架时间:
                                    <span th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"></span>
                                </small>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <small class="text-muted">
                                    <i class="bi bi-clock-history"></i> 更新时间:
                                    <span th:text="${#temporals.format(product.updatedAt, 'yyyy-MM-dd')}"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addToCartForm = document.getElementById('addToCartForm');

        if (addToCartForm) {
            addToCartForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;

                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
                submitBtn.disabled = true;

                const formData = new FormData(this);

                fetch(this.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(formData)
                }).then(response => {
                    if (response.ok) {
                        const toast = new bootstrap.Toast(document.getElementById('success-toast'));
                        toast.show();
                    }
                }).catch(error => {
                    console.error('Error:', error);
                }).finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });

                return false;
            });
        }

        const quantityInput = document.getElementById('quantity');
        if (quantityInput) {
            quantityInput.addEventListener('change', function() {
                const max = parseInt(this.getAttribute('max'));
                const value = parseInt(this.value);

                if (value < 1) {
                    this.value = 1;
                } else if (value > max) {
                    this.value = max;
                }
            });

            quantityInput.addEventListener('input', function() {
                const max = parseInt(this.getAttribute('max'));
                const value = parseInt(this.value) || 0;

                if (value > max) {
                    this.value = max;
                }
            });
        }
    });
</script>
</body>
</html>